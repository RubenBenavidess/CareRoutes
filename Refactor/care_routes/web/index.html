<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">
  
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="CareRoutes - Sistema de gesti√≥n de rutas">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="CareRoutes">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>
  
  <title>CareRoutes</title>
  <link rel="manifest" href="manifest.json">

  <style>
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #F2F2F2;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-family: 'Segoe UI', -apple-system, sans-serif;
      z-index: 9999;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0973AD;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #0973AD;
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .loading-subtext {
      color: #666;
      font-size: 14px;
    }
    
    body.loaded #loading {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Cargando CareRoutes</div>
    <div class="loading-subtext">Inicializando...</div>
  </div>

  <!-- Configuraci√≥n para sqlite3 WASM -->
  <script>
    // Configuraci√≥n global para SQLite3 WASM
    window.sqlite3InitModule = window.sqlite3InitModule || function() {
      console.warn('SQLite3 WASM module not available, using fallback');
      return Promise.reject(new Error('SQLite3 WASM not available'));
    };
    
    // Service worker version por defecto
    window.serviceWorkerVersion = window.serviceWorkerVersion || null;
    
    // Configuraci√≥n adicional
    window.addEventListener('load', function() {
      console.log('üåê Web environment loaded');
    });
    
    // Manejo de errores globales
    window.addEventListener('error', function(e) {
      console.error('‚ùå Global error:', e.error);
      const loadingSubtext = document.querySelector('.loading-subtext');
      if (loadingSubtext) {
        loadingSubtext.textContent = 'Error de carga detectado...';
        loadingSubtext.style.color = '#e53e3e';
      }
    });
    
    window.addEventListener('unhandledrejection', function(e) {
      console.error('‚ùå Unhandled promise rejection:', e.reason);
    });
  </script>

  <!-- Flutter Web Bootstrap -->
  <script src="flutter_bootstrap.js" async></script>
  
  <script>
    // Funci√≥n para inicializar la app
    function initializeApp() {
      const loadingSubtext = document.querySelector('.loading-subtext');
      
      if (loadingSubtext) {
        loadingSubtext.textContent = 'Iniciando aplicaci√≥n...';
      }
      
      // Configuraci√≥n del service worker
      const serviceWorkerSettings = {
        serviceWorkerVersion: window.serviceWorkerVersion,
      };
      
      // Inicializar Flutter
      if (window._flutter && window._flutter.loader) {
        window._flutter.loader.load({
          serviceWorkerSettings: serviceWorkerSettings,
          onEntrypointLoaded: function(engineInitializer) {
            engineInitializer.initializeEngine().then(function(appRunner) {
              // Ocultar loading screen
              document.body.classList.add('loaded');
              
              // Ejecutar la app
              appRunner.runApp();
              
              console.log('‚úÖ CareRoutes loaded successfully');
            }).catch(function(error) {
              console.error('‚ùå Error initializing engine:', error);
              showError('Error al inicializar la aplicaci√≥n');
            });
          }
        });
      } else {
        console.error('‚ùå Flutter loader not available');
        showError('Flutter no est√° disponible');
      }
    }
    
    // Funci√≥n para mostrar errores
    function showError(message) {
      const loadingText = document.querySelector('.loading-text');
      const loadingSubtext = document.querySelector('.loading-subtext');
      const spinner = document.querySelector('.spinner');
      
      if (spinner) spinner.style.display = 'none';
      if (loadingText) {
        loadingText.textContent = 'Error';
        loadingText.style.color = '#e53e3e';
      }
      if (loadingSubtext) {
        loadingSubtext.textContent = message;
        loadingSubtext.style.color = '#e53e3e';
      }
    }
    
    // Esperar a que se cargue todo
    window.addEventListener('load', function(ev) {
      // Timeout para cargar la app
      setTimeout(initializeApp, 100);
    });
    
    // Fallback si no se carga en 10 segundos
    setTimeout(function() {
      if (!document.body.classList.contains('loaded')) {
        showError('Tiempo de carga agotado. Recarga la p√°gina.');
      }
    }, 10000);
  </script>
</body>
</html>